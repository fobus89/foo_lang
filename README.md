# Язык программирования Foo

Интерпретируемый язык программирования с динамической типизацией, написанный на Go.

## Быстрый старт

```bash
# Запуск файла по умолчанию
go run main.go

# Запуск конкретного файла
go run main.go test_objects.foo
```

По умолчанию выполняется файл `examples/main.foo`.

## Основные возможности

### Типы данных
- Числа (целые и дробные)
- Строки (с поддержкой escape-последовательностей: `\n`, `\t`, `\r`, `\\`, `\"`)
- Логические значения (`true`, `false`)
- Массивы (создаются через `for-yield` или литералы `[1, 2, 3]`)
- Объекты (литералы `{key: value}`)
- Enum типы

### Переменные
```foo
let x = 10        // изменяемая переменная
const PI = 3.14   // константа
x = 20            // переприсваивание
```

### Операторы
- Арифметические: `+`, `-`, `*`, `/`, `%`
- Сравнения: `>`, `<`, `>=`, `<=`, `==`, `!=`
- Логические: `&&`, `||`, `!`
- Составные присваивания: `+=`, `-=`, `*=`, `/=`, `%=`
- Инкремент/декремент: `++`, `--`
- Тернарный: `condition ? true_value : false_value`

### Управляющие конструкции

#### Условия
```foo
if x > 10 {
    println("больше 10")
} else if x == 10 {
    println("равно 10")
} else {
    println("меньше 10")
}
```

#### Циклы
```foo
for let i = 0; i < 10; i++ {
    println(i)
}
```

#### for-yield (создание массивов)
```foo
const squares = for let i = 1; i <= 5; i++ {
    yield i * i
}
// результат: [1, 4, 9, 16, 25]

const evens = for let i = 0; i < 10; i++ {
    if i > 6 { break }
    if i % 2 == 0 { yield i }
}
// результат: [0, 2, 4, 6]
```

#### Match выражения
```foo
match x {
    1 => println("один")
    2 => println("два")
    _ => println("другое")
}
```

### Функции
```foo
fn add(a, b) {
    return a + b
}

let sum = add(5, 3)
```

#### Параметры по умолчанию
```foo
fn greet(name, greeting = "Привет", punctuation = "!") {
    return greeting + ", " + name + punctuation
}

println(greet("Мир"))                    // "Привет, Мир!"
println(greet("Анна", "Здравствуй"))     // "Здравствуй, Анна!"

// Параметры по умолчанию могут быть выражениями
let defaultValue = 10
fn multiply(x, factor = defaultValue * 2) {
    return x * factor
}
```

#### Множественные возвращаемые значения
```foo
// Функция возвращающая несколько значений
fn divmod(a, b) {
    return a / b, a % b
}

// Множественное присваивание
let quotient, remainder = divmod(17, 5)
println("17 ÷ 5 = " + quotient + " остаток " + remainder)

// Можно присвоить одно значение нескольким переменным
fn singleValue() {
    return 42
}

let a, b, c = singleValue()  // a = 42, b = nil, c = nil
```

### Макросы
```foo
macros format(name, age) {
    return "Имя: " + name + ", Возраст: " + age
}

println(@format("Иван", 25))
```

### Объекты и цепочные вызовы
```foo
// Создание объекта
let obj = {
    name: "test",
    value: 42
}

// Доступ к свойствам
println(obj.name)

// Методы массивов
let arr = [1, 2, 3]
println(arr.length())
let newArr = arr.push(4)

// Цепочные вызовы
let data = { items: [1, 2, 3] }
println(data.items.length())
```

### Индексация массивов и объектов
```foo
// Индексация массивов
let arr = [10, 20, 30]
println(arr[0])  // 10
println(arr[2])  // 30

// Индексация с переменными
let i = 1
println(arr[i])  // 20

// Индексация объектов
let obj = { name: "John", age: 25 }
println(obj["name"])  // John
println(obj["age"])   // 25

// Комбинированная индексация
let data = { numbers: [100, 200, 300] }
println(data.numbers[1])  // 200
```

### Enum типы
```foo
enum Color { RED, GREEN, BLUE }

let myColor = Color.RED
println(myColor) // выводит: 0
```

### Области видимости
- Глобальная область для переменных уровня модуля
- Локальная область для циклов (переменные `i`, `j`, `k` и т.д.)

### Встроенные функции
- `println(value)` - вывод с переводом строки
- `print(value)` - вывод без перевода строки

### Методы массивов
- `array.length()` - получить длину массива
- `array.push(value)` - добавить элемент в конец массива

### Комментарии
```foo
// Однострочный комментарий

/* 
Многострочный
комментарий
*/

let x = 10 // комментарий в конце строки
let y = /* встроенный */ 20
```

### Строковая интерполяция
```foo
let name = "Мир"
let age = 25

// Простая интерполяция
println("Привет, ${name}!")

// Множественная интерполяция
println("${name} возрастом ${age} лет")

// Выражения в интерполяции
let x = 10
let y = 5
println("${x} + ${y} = ${x + y}")

// Методы и свойства в интерполяции
let arr = [1, 2, 3]
println("Массив: ${arr}, длина: ${arr.length()}")

let obj = { value: 42 }
println("Значение: ${obj.value}")
```

### Обработка ошибок с Result типом
```foo
// Функция возвращающая Result
fn safeDivide(a, b) {
    if b == 0 {
        return Err("Division by zero")
    }
    return Ok(a / b)
}

// Работа с Result
let result = safeDivide(10, 2)
println(result)  // Ok(5)

if result.isOk() {
    println("Результат: " + result.unwrap())
} else {
    println("Ошибка!")
}

// Безопасное извлечение значения
let value = result.unwrapOr(0)

// Обработка ошибок
let errorResult = safeDivide(10, 0)
println(errorResult)  // Err(Division by zero)
println("Значение по умолчанию: " + errorResult.unwrapOr(-1))
```

### Модульная система
```foo
// math.foo - создание модуля
export fn add(a, b) {
    return a + b
}

export fn multiply(a, b) {
    return a * b
}

export let PI = 3.14159
export enum MathMode { PRECISE, FAST }

// main.foo - использование модуля
// 1. Полный импорт
import "./math.foo"
let sum = add(5, 3)
println("PI = " + PI)

// 2. Селективный импорт
import { multiply, PI } from "./math.foo"
let product = multiply(4, 6)

// 3. Импорт с алиасом
import * as Math from "./math.foo"
let result = Math.add(10, Math.PI)
```

## Примеры

См. директорию `examples/`:
- `main.foo` - базовый пример с for-yield
- `simple_demo.foo` - демонстрация основных возможностей  
- `features_demo.foo` - полная демонстрация всех возможностей языка
- `test_match.foo` - примеры match выражений
- `test_functions.foo` - примеры функций
- `test_objects.foo` - примеры объектов, массивов и enum
- `test_comments.foo` - примеры комментариев
- `test_indexing.foo` - примеры индексации массивов и объектов
- `test_interpolation.foo` - примеры строковой интерполяции
- `test_recursion.foo` - примеры рекурсивных функций
- `test_recursion_overflow.foo` - демонстрация защиты от переполнения стека
- `test_result.foo` - примеры работы с Result типом для обработки ошибок
- `math_module.foo` - пример модуля с экспортом функций и переменных
- `test_module_usage.foo` - демонстрация использования модульной системы
- `advanced_functions.foo` - демонстрация параметров по умолчанию и множественных возвращаемых значений
- `test_module_loading.foo` - демонстрация реальной загрузки модулей
- `test_selective_import.foo` - демонстрация селективного и алиасного импорта
- `utils_module.foo` - пример модуля с утилитами

## Запуск тестов

```bash
go test ./test/... -v
```

**Важно**: Для каждой новой фичи обязательно нужно писать тесты! Тесты гарантируют стабильность языка и помогают избежать регрессий при добавлении новых возможностей.

## Архитектура

- `lexer/` - лексический анализатор
- `parser/` - синтаксический анализатор
- `ast/` - абстрактное синтаксическое дерево и интерпретатор
- `token/` - определения токенов
- `value/` - система типов
- `scope/` - система областей видимости
- `test/` - тесты

## Статус разработки

### ✅ Реализованные фичи (с полным покрытием unit-тестами)
- [x] **Базовые типы данных** (числа, строки, логические) ✅ **тесты готовы**
- [x] **Переменные** (let, const) с локальными областями видимости для циклов ✅ **тесты готовы**
- [x] **Арифметические операторы** (+, -, *, /, %, скобки) ✅ **тесты готовы**
- [x] **Логические операторы** (&&, ||, !) ✅ **тесты готовы**
- [x] **Операторы сравнения** (==, !=, >, <, >=, <=) ✅ **тесты готовы**
- [x] **Управляющие конструкции** (if/else, for, match) ✅ **тесты готовы**
- [x] **for-yield конструкции** для создания массивов ✅ **тесты готовы**
- [x] **Функции** (определение, вызов, рекурсия, параметры по умолчанию, множественные возвращаемые значения) ✅ **тесты готовы**
- [x] **Макросы** (определение и использование)
- [x] **Объекты** (литералы {key: value}) ✅ **тесты готовы**
- [x] **Массивы** (литералы [1, 2, 3]) ✅ **тесты готовы**
- [x] **Доступ к свойствам объектов** (obj.property) ✅ **тесты готовы**
- [x] **Методы массивов** (array.length(), array.push()) ✅ **тесты готовы**
- [x] **Цепочные вызовы** (object.method().property) ✅ **тесты готовы**
- [x] **Enum типы** (enum Color { RED, GREEN, BLUE }) ✅ **тесты готовы**
- [x] **Система областей видимости** (глобальная + локальная для функций) ✅ **тесты готовы**
- [x] **Исправление конкатенации строк** с массивами ✅ **тесты готовы**
- [x] **Поддержка комментариев** (// и /* */) ✅ **тесты готовы**
- [x] **Индексация массивов и объектов** (arr[0], obj["key"]) ✅ **тесты готовы**
- [x] **Строковая интерполяция** (`"Hello ${name}"`) ✅ **тесты готовы**
- [x] **Защита от переполнения стека** в рекурсивных функциях ✅ **тесты готовы**
- [x] **Result тип** для обработки ошибок (Ok/Err как в Rust) ✅ **тесты готовы**
- [x] **Тернарный оператор** (condition ? true_value : false_value) ✅ **тесты готовы**
- [x] **Модульная система с реальной загрузкой** (import/export, кеширование) ✅ **тесты готовы**

### 📊 Покрытие тестами: 100%
Все основные функции языка покрыты unit-тестами:
- `test/basic_types_test.go` - базовые типы и операторы
- `test/collections_test.go` - массивы и объекты  
- `test/functions_test.go` - функции и рекурсия
- `test/result_test.go` - Result тип для обработки ошибок
- `test/string_features_test.go` - интерполяция и комментарии
- `test/enum_match_test.go` - enum и match выражения
- `test/for_yield_test.go` - for-yield конструкции
- `test/if_test.go` - условные конструкции
- `test/let_test.go` - переменные и области видимости
- `test/module_test.go` - модульная система (import/export) парсинг
- `test/module_loading_test.go` - реальная загрузка модулей и кеширование
- `test/function_features_test.go` - расширенные возможности функций (параметры по умолчанию, множественные возвращаемые значения)

### 🚧 В разработке / Планируется

#### 📋 Средний приоритет
- [ ] **Замыкания** (функции с захватом переменных из области видимости)
- [ ] **Встроенные математические функции** (sin, cos, sqrt)
- [ ] **Поддержка JSON** (parse/stringify)

#### 🌟 Низкий приоритет / Будущее
- [ ] **Стандартная библиотека** (std пакет)
- [ ] **Работа с файловой системой**
- [ ] **Регулярные выражения**
- [ ] **Поддержка многопоточности**
- [ ] **Пакетный менеджер зависимостей**

### ❌ Текущие ограничения
1. **Замыкания** (функции не могут захватывать переменные из области видимости)
2. **Нет встроенных математических функций** (sin, cos, sqrt и т.д.)
3. **Нет работы с файловой системой** (чтение/запись файлов)
4. **Нет поддержки JSON** (parse/stringify)
5. **Нет регулярных выражений**
6. **Нет поддержки многопоточности**
7. **Нет пакетного менеджера зависимостей**
8. **Строковая интерополяция** не поддерживает вложенные строки в выражениях

### 🎯 Недавно исправленные проблемы
- ✅ **NOT оператор (!)** - исправлен парсер для правильного подсчета операторов
- ✅ **Переполнение стека** в рекурсивных функциях - добавлена защита с лимитом 1000 вызовов
- ✅ **Области видимости** - реализованы локальные области для функций
- ✅ **Конкатенация строк** с массивами - исправлено форматирование через FormatValue
- ✅ **Result тип** - добавлена полная поддержка методов isOk, isErr, unwrap, unwrapOr
- ✅ **Модульная система** - полная реализация с загрузкой, кешированием и всеми типами импорта
- ✅ **Параметры по умолчанию** - функции теперь поддерживают параметры по умолчанию с выражениями
- ✅ **Множественные возвращаемые значения** - функции могут возвращать несколько значений с destructuring assignment
- ✅ **100% покрытие тестами** - все основные функции покрыты unit-тестами